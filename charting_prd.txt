# Financial Charting Tool (uPlot + Python) - RPG Method PRD

## Overview

### Problem Statement
Financial analysts and traders often possess large datasets (CSV files) of OHLC (Open, High, Low, Close) data. Visualizing this data efficiently in a browser is challenging due to performance bottlenecks in standard charting libraries when handling millions of data points. Existing local tools are often clunky, while web-based tools (like TradingView) require uploading data to third-party servers or lack custom indicator flexibility.

### Target Users
- **Quantitative Analysts/Traders**: Need to visualize local CSV backtest data or historical market data.
- **Developers**: Need a high-performance visualization layer for their trading bots.

### Success Metrics
- **Render Performance**: Render 500k+ points at 60fps.
- **Load Time**: Parse and display a 100MB CSV in under 2 seconds.
- **Interactivity**: Zoom/Pan latency < 16ms (1 frame).
- **Accuracy**: Indicators (RSI, EMA) match standard TA-Lib output.

---

## Functional Decomposition

### Capability: Data Ingestion & Storage
The system must ingest raw CSV files and structure them for efficient processing.

#### Feature: CSV Parsing
- **Description**: Load CSV files containing timestamp, open, high, low, close, and volume data.
- **Inputs**: File path or uploaded file object.
- **Outputs**: Pandas DataFrame with datetime index.
- **Behavior**: Detect date formats, handle missing values, sort by time.

### Capability: Core Data Processing
The engine for mathematical transformations and data shaping.

#### Feature: Technical Indicator Engine
- **Description**: Calculate derived series based on user requests.
- **Inputs**: OHLC DataFrame, Indicator config (e.g., `{ "type": "RSI", "period": 14 }`).
- **Outputs**: Series array aligned with the original timestamp index.
- **Behavior**: Compute Moving Averages, Oscillators, etc., ensuring NaN handling for lookback periods.

#### Feature: Downsampling (Level of Detail)
- **Description**: Reduce data density for zoomed-out views to maintain performance.
- **Inputs**: DataFrame, Target pixel width / max points.
- **Outputs**: Resampled DataFrame (e.g., converting 1-minute candles to 1-hour candles).
- **Behavior**: Time-based aggregation (O=first, H=max, L=min, C=last, V=sum).

#### Feature: Columnar Pivoting
- **Description**: Convert row-based DataFrames into uPlot-compatible columnar JSON.
- **Inputs**: DataFrame.
- **Outputs**: JSON structure `[ [timestamps...], [opens...], [highs...], ... ]`.
- **Behavior**: Efficient numpy array serialization to list of lists.

### Capability: API Layer
The bridge between the Python backend and the browser.

#### Feature: Data Endpoint
- **Description**: Serve the pivoted data to the frontend.
- **Inputs**: Query params (Filename, Indicators, Zoom Level/Time Range).
- **Outputs**: Columnar JSON.
- **Behavior**: Fetch data, run calculations, pivot, and stream response.

### Capability: Visualization (Frontend)
The interactive layer using uPlot.

#### Feature: Chart Initialization
- **Description**: Configure uPlot instance with specific series and axes.
- **Inputs**: DOM Element, Configuration Object.
- **Outputs**: Rendered Canvas Chart.
- **Behavior**: Setup native OHLC rendering and Line rendering for indicators.

#### Feature: Dynamic Zoom/Pan
- **Description**: Handle user interactions to request new data resolutions.
- **Inputs**: Mouse/Touch events.
- **Outputs**: Updated chart view / API call for new data.
- **Behavior**: Debounce scroll events, determine if new resolution is needed, fetch and update data.

---

## Repository Structure

```
project-root/
├── src/
│   ├── ingestion/           # Capability: Data Ingestion
│   │   ├── loader.py        # CSV parsing logic
│   │   └── schema.py        # Pydantic models for data validation
│   ├── processing/          # Capability: Core Data Processing
│   │   ├── indicators.py    # TA logic (RSI, EMA)
│   │   ├── resampler.py     # Downsampling logic
│   │   └── pivot.py         # Row-to-Column transformation
│   ├── api/                 # Capability: API Layer
│   │   ├── main.py          # FastAPI entry point
│   │   └── routes.py        # Endpoint definitions
│   └── frontend/            # Capability: Visualization
│       ├── index.html       # Main entry
│       ├── chart.js         # uPlot configuration and state management
│       └── data-client.js   # Fetch wrappers
├── data/                    # Storage for CSVs
├── tests/
└── requirements.txt
```

## Module Definitions

### Module: Ingestion
- **Maps to capability**: Data Ingestion
- **Responsibility**: Loading raw data into memory.
- **Exports**:
  - `load_csv(path) -> DataFrame`

### Module: Processing
- **Maps to capability**: Core Data Processing
- **Responsibility**: Math and reshaping.
- **Exports**:
  - `calculate_indicator(df, type, params) -> Series`
  - `resample_ohlc(df, timeframe) -> DataFrame`
  - `to_uplot_format(df) -> List[List]`

### Module: API
- **Maps to capability**: API Layer
- **Responsibility**: HTTP transport.
- **Exports**:
  - `GET /chart-data`

### Module: Frontend
- **Maps to capability**: Visualization
- **Responsibility**: Rendering and Interaction.
- **Exports**:
  - `ChartManager` class

---

## Dependency Graph

### Foundation Layer (Phase 0)
- **Ingestion**: No dependencies. (Python/Pandas)
- **Processing**: Depends on **Ingestion**. (Needs data structures to operate on)

### Application Layer (Phase 1)
- **API**: Depends on **Processing** (to get data) and **Ingestion** (to load files).

### Presentation Layer (Phase 2)
- **Frontend**: Depends on **API** (to receive data).

---

## Implementation Roadmap

### Phase 0: Core Logic
**Goal**: Can load a CSV, calculate an RSI, and output a generic Python list of lists.
**Entry Criteria**: Empty repo with Python environment.
**Tasks**:
- [ ] Implement `ingestion.loader` to read CSV into Pandas.
- [ ] Implement `processing.indicators` (Simple Moving Average, RSI).
- [ ] Implement `processing.pivot` to transform DataFrame to List[List].
**Exit Criteria**: A unit test loads a dummy CSV and asserts the output format is correct.

### Phase 1: API Service
**Goal**: A running local server that returns JSON data.
**Entry Criteria**: Phase 0 complete.
**Tasks**:
- [ ] Setup FastAPI project structure.
- [ ] Create `GET /data` endpoint that accepts a filename.
- [ ] Connect endpoint to ingestion and processing modules.
**Exit Criteria**: `curl localhost:8000/data?file=test.csv` returns valid JSON.

### Phase 2: Basic Visualization
**Goal**: A static chart rendering the CSV data.
**Entry Criteria**: Phase 1 complete.
**Tasks**:
- [ ] Create `index.html` with uPlot CDN link.
- [ ] Implement `data-client.js` to fetch from API.
- [ ] Implement `chart.js` to render a basic Line chart (Close price).
**Exit Criteria**: Browser shows a static line chart of the data.

### Phase 3: Advanced Visualization
**Goal**: Full OHLC support and Indicators.
**Entry Criteria**: Phase 2 complete.
**Tasks**:
- [ ] Implement Native OHLC rendering in `chart.js` (using uPlot paths).
- [ ] Add Indicator support in API (query params).
- [ ] Render Indicators as separate series/axes in frontend.
- [ ] Implement Zoom/Pan handling (potentially just client-side for <500k rows initially).
**Exit Criteria**: Chart looks like a basic TradingView clone with candlesticks and one indicator.

---

## Test Strategy

### Test Pyramid
- **Unit Tests (70%)**: Focus on `processing` logic. Verify RSI math and Pivot formatting.
- **Integration Tests (20%)**: Verify API endpoints return correct structure given a CSV.
- **E2E (10%)**: Manual verification of the chart rendering (hard to automate canvas testing cheaply).

### Critical Test Scenarios
- **Data Alignment**: Ensure RSI array length matches Timestamp array length (padding NaNs).
- **Empty Data**: Handle CSVs with no rows gracefully.
- **Missing Columns**: Error if CSV lacks 'Close' or 'Time'.

---

## Architecture

### Technology Stack
- **Backend**: Python 3.11+, FastAPI, Pandas, Numpy.
- **Frontend**: Vanilla JS (ES6+), uPlot.css/js.
- **Decision**: Vanilla JS over React/Vue.
  - **Rationale**: The state complexity is low (mostly in the chart instance), and we want maximum raw performance without virtual DOM overhead for the canvas wrapper.

### Data Models
- **Internal**: Pandas DataFrame (Index=Datetime, Cols=Open,High,Low,Close,Volume).
- **External (API)**: `[ [Time...], [Open...], [High...], [Low...], [Close...], [Ind1...], [Ind2...] ]`.

---

## Risks

### Technical Risks
- **Risk**: uPlot Candle rendering is complex to configure manually.
  - **Mitigation**: Copy exact config from uPlot official "OHLC" demo.
- **Risk**: Large CSVs cause Backend OOM (Out of Memory).
  - **Mitigation**: Use `pandas.read_csv(chunksize=...)` if needed, but for MVP assume <1GB files fit in RAM.

### Scope Risks
- **Risk**: User wants "Infinite Scroll" (Dynamic Loading).
  - **Mitigation**: strictly scoped to "Load Full File" for MVP. Dynamic loading requires complex backend windowing logic.

